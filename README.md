# Прототип гексагонального клиента TLA

Экспериментальный онлайн-прототип с гексагональной сеткой: клиент на PixiJS и сервер на Node.js с WebSocket. Монорепозиторий состоит из трёх рабочих пространств: `client`, `server` и `shared`.

## Предварительные требования

- Node.js 20+
- npm 9+

## Быстрый старт

Установите зависимости во всех рабочих пространствах:

```bash
npm install
```

### Разработка

Запустите клиент и сервер в режиме разработки одновременно:

```bash
npm run dev
```

- Клиент: http://localhost:5173
- Сервер: ws://localhost:3001

### Сборка

Создайте production-сборки для общих пакетов, сервера и клиента:

```bash
npm run build
```

Просмотрите собранный клиентский бандл:

```bash
npm run preview
```

### Тесты

Запустите модульные тесты для гексагональной сетки в `shared`:

```bash
npm run test
```

### Архив проекта

Создайте `.zip`-архив без бинарных артефактов (node_modules, dist и пр.):

```bash
npm run archive
```

Готовый файл будет лежать в `artifacts/project.zip`.

## Структура проекта

```
.
├── client      # фронтенд на Vite + PixiJS (PWA)
├── server      # авторитетный сервер на Node.js WebSocket
├── shared      # общие типы и утилиты работы с сеткой на TypeScript
├── assets      # заготовка для будущих ассетов
└── docs        # документация по формату карт и протоколу
```

## Возможности

- Гексагональная сетка 64×64 в изометрическом ромбе.
- Панорамирование и масштабирование мышью или жестами (щипок).
- Выбор клетки перемещает локальный маркер и рассылает позицию другим игрокам.
- Встроенный редактор карт с инструментами рисования/стирания, импортом/экспортом JSON и сохранением PNG.
- Адаптивный интерфейс с экранами входа, регистрации и создания персонажа, а также полноэкранной подсказкой на мобильных устройствах.
- Клиент готов к офлайн-режиму благодаря service worker и манифесту.
- Демо-комната использует фрагмент карты Arroyo, импортированный из классического сервера TLAmk.

Дополнительные подробности см. в файлах [MAP_FORMAT.md](docs/MAP_FORMAT.md) и [PROTOCOL.md](docs/PROTOCOL.md).

## Деплой на Render

- Используйте blueprint [render.yaml](render.yaml), чтобы создать **один** веб-сервис в Render: он собирает клиент и сервер и обслуживает статику с того же домена. Команда сборки в blueprint-файле уже включает `npm install --include=dev`, поэтому TypeScript и типы устанавливаются даже при `NODE_ENV=production`.
- Подробный пошаговый сценарий настройки описан в [DEPLOY_RENDER.md](docs/DEPLOY_RENDER.md).
- Переменная окружения `VITE_WS_URL` теперь опциональна — по умолчанию клиент подключается к WebSocket на том же хосте, что и фронтенд.

## Подготовка к FRM-ассетам

- Клиентская сборка понимает импорт файлов `.frm` как URL, текст или `ArrayBuffer`, что позволяет хранить бинарники вне репозитория.
- В [FRM_ASSETS.md](docs/FRM_ASSETS.md) описан рекомендуемый пайплайн для конвертации и подключения спрайтов Fallout.

### Модуль `shared/src/fr-loader.ts`

- `parseFr(buffer: ArrayBuffer)` — разбирает заголовок Fallout FRM/FR1/FR2-файла, корректно определяет эндильность, разносит кадры по шести направлениям и возвращает структуру `FrDecoded` с метаданными (смещения, FPS, кадр действия).
- `applyPalette(decoded: FrDecoded, palette: Uint8Array | number[][])` — накладывает цветовую палитру на индексированные пиксели, превращая их в массивы `Uint8ClampedArray` с RGBA-данными. Для удобства модуль экспортирует готовую палитру `FALLOUT_GIMP_PALETTE`, соответствующую официальной таблице цветов Fallout (индекс 0 = прозрачность).
- `parsePaletteFile` и сопутствующие утилиты нормализуют палитры форматов COLOR.PAL/ACT/JASC/GIMP GPL. Любые ошибки валидации оборачиваются в человекочитаемые сообщения на русском языке.
- Для повторного использования предусмотрено клонирование кадров и запасные проверки правдоподобности данных (размеры, смещения, количество кадров), что упрощает работу с повреждёнными ресурсами.

### CLI `fr-decode.js`

- Запуск: `node fr-decode.js путь/к/анимации.frm [палитра.pal] out/каталог`.
- Скрипт конвертирует все направления и кадры FRM-файла в PNG c альфаканалом и формирует JSON с метаданными (`fps`, смещения, имя файла). Палитру можно не указывать — по умолчанию берётся `FALLOUT_GIMP_PALETTE`.

### Визуальное демо FRM

- Команда `npm run demo` открывает Vite-страницу `client/src/screens/fr-demo.ts`. На ней можно перетащить файлы FRM и PAL, просмотреть анимацию с выбранной палитрой, переключать направления и листать кадры.
- Демонстрационный экран выводит информацию о заголовке (FPS, action frame, количество кадров), отображает спрайт-лист и использует `applyPalette` для мгновенного раскрашивания.
- Стили вынесены в `client/src/styles/fr-demo.css`, поэтому модуль легко адаптировать под PixiJS/Phaser.

## Импорт карт TLAmk

- Скрипт `npm run import:fomap -- --input путь/к/карте.fomap --output server/src/maps/<имя>.json --size 64` конвертирует исходные карты FOnline/TLAmk в текущий JSON-формат, нормализуя координаты к диапазону 64×64.
- В выходной файл автоматически добавляются метаданные `source`, позволяющие отследить оригинал и повторно прогонять импорт при обновлении исходников.
- Текущая `server/src/maps/demo.json` сгенерирована именно так из `arroyo.fomap` и служит примером портирования.
